import React, { useState, useEffect, useRef } from 'react';
import { Html5QrcodeScanner, Html5QrcodeSupportedFormats } from 'html5-qrcode';

interface TicketInfo {
  id: string;
  ticketId: string;
  eventName: string;
  customerName: string;
  customerEmail: string;
  isUsed: boolean;
  usedAt?: string;
  validatedBy?: string;
}

export default function QRScanner() {
  const [ticketInfo, setTicketInfo] = useState<TicketInfo | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [scannerActive, setScannerActive] = useState(false);
  const [success, setSuccess] = useState<string | null>(null);
  const [ticketStatus, setTicketStatus] = useState<'fresh' | 'already-used' | 'just-used'>('fresh');
  
  const scannerRef = useRef<Html5QrcodeScanner | null>(null);
  const scannerElementRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    return () => {
      // Nettoyer le scanner au d√©montage
      if (scannerRef.current) {
        scannerRef.current.clear();
      }
    };
  }, []);

  const startScanner = () => {
    if (scannerRef.current) {
      scannerRef.current.clear();
    }

    setError(null);
    setSuccess(null);
    setTicketInfo(null);
    setScannerActive(true);

    const config = {
      fps: 10,
      qrbox: { width: 250, height: 250 },
      aspectRatio: 1.0,
      supportedFormats: [Html5QrcodeSupportedFormats.QR_CODE],
      showTorchButtonIfSupported: true,
      showZoomSliderIfSupported: true,
      defaultZoomValueIfSupported: 2,
      useBarCodeDetectorIfSupported: true,
    };

    scannerRef.current = new Html5QrcodeScanner(
      "qr-reader",
      config,
      false
    );

    scannerRef.current.render(
      (decodedText, decodedResult) => {
        console.log('QR Code d√©tect√©:', decodedText);
        handleQRCodeDetected(decodedText);
      },
      (errorMessage) => {
        // Ignorer les erreurs de scan (trop fr√©quentes)
        if (!errorMessage.includes('No QR code found')) {
          console.log('Erreur de scan:', errorMessage);
        }
      }
    );
  };

  const stopScanner = () => {
    if (scannerRef.current) {
      scannerRef.current.clear();
      scannerRef.current = null;
    }
    setScannerActive(false);
  };

  const handleQRCodeDetected = async (qrData: string) => {
    console.log('üéØ QR Code d√©tect√©:', qrData);
    
    // Arr√™ter le scanner
    stopScanner();
    
    setLoading(true);
    setError(null);
    setSuccess(null);

    try {
      // Extraire l'ID du ticket
      let ticketId = qrData;
      
      // Si c'est une URL compl√®te, extraire l'ID
      const urlMatch = qrData.match(/\/api\/ticket\/validate\/(.+)$/);
      if (urlMatch) {
        ticketId = urlMatch[1];
        console.log('üìù ID extrait de l\'URL:', ticketId);
      } else {
        console.log('üìù ID direct:', ticketId);
      }
      
      console.log('üîç Validation du ticket:', ticketId);

      const response = await fetch(`/api/ticket/validate/${ticketId}`);
      const result = await response.json();

      if (result.success) {
        // V√©rifier si le ticket a d√©j√† √©t√© utilis√© AVANT de le marquer comme utilis√©
        if (result.ticket.isUsed) {
          setTicketInfo(result.ticket);
          setError('‚ùå Ce ticket a d√©j√† √©t√© utilis√© !');
          setSuccess(null);
          setTicketStatus('already-used');
          console.log('‚ùå Ticket d√©j√† utilis√©:', result.ticket);
          return;
        }
        
        // Afficher d'abord le ticket comme valide
        setTicketInfo(result.ticket);
        setSuccess('‚úÖ Ticket valid√© avec succ√®s !');
        setTicketStatus('fresh');
        console.log('‚úÖ Ticket valid√©:', result.ticket);
        
        // Marquer automatiquement le ticket comme utilis√©
        console.log('üîÑ Marquage automatique du ticket comme utilis√©...');
        await markTicketAsUsed(ticketId);
      } else {
        setError(result.error || 'Ticket invalide ou non trouv√©');
        console.error('‚ùå Erreur validation:', result.error);
      }
    } catch (error) {
      console.error('Erreur lors de la validation:', error);
      setError('Erreur lors de la validation du ticket');
    } finally {
      setLoading(false);
    }
  };

  const markTicketAsUsed = async (ticketId: string) => {
    try {
      const response = await fetch(`/api/ticket/validate/${ticketId}`, {
        method: 'PUT',
      });

      const result = await response.json();
      
      if (result.success) {
        // Mettre √† jour les informations du ticket avec le statut "utilis√©"
        setTicketInfo(result.ticket);
        setSuccess('‚úÖ Ticket valid√© et marqu√© comme utilis√© automatiquement !');
        setTicketStatus('just-used');
        console.log('‚úÖ Ticket marqu√© comme utilis√©:', result.ticket);
      } else {
        console.error('‚ùå Erreur lors du marquage automatique:', result.error);
        setError('Erreur lors du marquage automatique du ticket');
      }
    } catch (error) {
      console.error('Erreur lors du marquage automatique:', error);
      setError('Erreur lors du marquage automatique du ticket');
    }
  };

  const markAsUsed = async () => {
    if (!ticketInfo) return;

    setLoading(true);
    setError(null);
    
    try {
      const response = await fetch(`/api/ticket/validate/${ticketInfo.ticketId}`, {
        method: 'PUT',
      });

      const result = await response.json();
      
      if (result.success) {
        setTicketInfo(result.ticket);
        setSuccess('‚úÖ Ticket marqu√© comme utilis√©');
      } else {
        setError(result.error || 'Erreur lors de la validation');
      }
    } catch (error) {
      console.error('Erreur lors de la validation:', error);
      setError('Erreur lors de la validation du ticket');
    } finally {
      setLoading(false);
    }
  };

  const resetScanner = () => {
    setTicketInfo(null);
    setError(null);
    setSuccess(null);
    setLoading(false);
    setTicketStatus('fresh');
  };

  return (
    <div style={{ 
      maxWidth: '800px', 
      margin: '0 auto', 
      padding: '20px',
      fontFamily: 'Arial, sans-serif',
      background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
      minHeight: '100vh'
    }}>
      <div style={{ 
        background: 'white', 
        borderRadius: '16px', 
        padding: '20px', 
        marginBottom: '20px',
        boxShadow: '0 8px 32px rgba(0,0,0,0.1)'
      }}>
        <h1 style={{ 
          textAlign: 'center', 
          margin: '0 0 20px 0', 
          color: '#333',
          fontSize: '28px'
        }}>
          üì± Scanner QR Code
        </h1>
        
        <div style={{ 
          background: '#f0f8ff', 
          padding: '15px', 
          borderRadius: '8px', 
          marginBottom: '20px',
          border: '1px solid #4a90e2',
          fontSize: '14px'
        }}>
          <strong>üìã Instructions :</strong>
          <br />1. Cliquez sur "D√©marrer le Scanner"
          <br />2. Autorisez l'acc√®s √† la cam√©ra
          <br />3. Pointez la cam√©ra vers un QR code
          <br />4. Le ticket sera valid√© ET marqu√© comme utilis√© automatiquement
          <br />
          <br /><strong>üé• Fonctionnalit√©s :</strong>
          <br />‚Ä¢ Flash automatique si disponible
          <br />‚Ä¢ Zoom pour am√©liorer la d√©tection
          <br />‚Ä¢ Support des QR codes de toutes tailles
          <br />‚Ä¢ Marquage automatique comme utilis√©
          <br />‚Ä¢ Protection contre la r√©utilisation
        </div>

        {error && (
          <div style={{ 
            background: '#fef2f2', 
            border: '1px solid #fecaca', 
            borderRadius: '12px', 
            padding: '15px', 
            marginBottom: '20px',
            color: '#dc2626',
            textAlign: 'center'
          }}>
            ‚ùå {error}
          </div>
        )}

        {success && (
          <div style={{ 
            background: '#f0f8ff', 
            border: '1px solid #4a90e2', 
            borderRadius: '12px', 
            padding: '15px', 
            marginBottom: '20px',
            color: '#4a90e2',
            textAlign: 'center'
          }}>
            {success}
          </div>
        )}

        {/* Scanner Section */}
        {!ticketInfo && (
          <div>
            <div style={{ textAlign: 'center', marginBottom: '20px' }}>
              {!scannerActive ? (
                <button 
                  onClick={startScanner}
                  disabled={loading}
                  style={{
                    background: loading ? '#ccc' : '#4a90e2',
                    color: 'white',
                    border: 'none',
                    padding: '15px 30px',
                    borderRadius: '12px',
                    fontSize: '16px',
                    cursor: loading ? 'not-allowed' : 'pointer',
                    fontWeight: 'bold',
                    boxShadow: '0 4px 8px rgba(0,0,0,0.2)',
                    marginRight: '10px'
                  }}
                >
                  {loading ? '‚è≥ Chargement...' : 'üé• D√©marrer le Scanner'}
                </button>
              ) : (
                <button 
                  onClick={stopScanner}
                  style={{
                    background: '#e24a4a',
                    color: 'white',
                    border: 'none',
                    padding: '15px 30px',
                    borderRadius: '12px',
                    fontSize: '16px',
                    cursor: 'pointer',
                    fontWeight: 'bold',
                    boxShadow: '0 4px 8px rgba(0,0,0,0.2)'
                  }}
                >
                  üõë Arr√™ter le Scanner
                </button>
              )}
            </div>

            {/* Zone du scanner */}
            <div 
              id="qr-reader"
              ref={scannerElementRef}
              style={{
                width: '100%',
                maxWidth: '600px',
                margin: '0 auto',
                borderRadius: '12px',
                overflow: 'hidden',
                boxShadow: '0 4px 8px rgba(0,0,0,0.2)'
              }}
            />
          </div>
        )}

        {/* Ticket Info Section */}
        {ticketInfo && (
          <div style={{ 
            background: ticketInfo.isUsed ? '#fef2f2' : '#f0f8ff', 
            border: `1px solid ${ticketInfo.isUsed ? '#fecaca' : '#4a90e2'}`, 
            borderRadius: '12px', 
            padding: '20px', 
            marginTop: '20px',
            textAlign: 'center'
          }}>
            <h3 style={{ 
              color: ticketStatus === 'already-used' ? '#dc2626' : '#4a90e2', 
              margin: '0 0 15px 0',
              fontSize: '24px'
            }}>
              {ticketStatus === 'already-used' ? '‚ùå Ticket D√©j√† Utilis√© !' : 
               ticketStatus === 'just-used' ? '‚úÖ Ticket Valid√© et Utilis√© !' : 
               '‚úÖ Ticket Valid√© et Utilis√© !'}
            </h3>
            
            <div style={{ 
              background: 'white', 
              padding: '15px', 
              borderRadius: '8px', 
              marginBottom: '15px',
              fontSize: '14px',
              textAlign: 'left'
            }}>
              <p><strong>üé´ ID du Ticket:</strong> {ticketInfo.ticketId}</p>
              <p><strong>üé™ √âv√©nement:</strong> {ticketInfo.eventName}</p>
              <p><strong>üë§ Client:</strong> {ticketInfo.customerName}</p>
              <p><strong>üìß Email:</strong> {ticketInfo.customerEmail}</p>
              <p><strong>üìä Statut:</strong> 
                <span style={{
                  color: ticketStatus === 'already-used' ? '#dc2626' : '#4a90e2',
                  fontWeight: 'bold',
                  marginLeft: '5px'
                }}>
                  {ticketStatus === 'already-used' ? '‚ùå D√©j√† utilis√©' : 
                   ticketStatus === 'just-used' ? '‚úÖ Valid√© et utilis√©' : 
                   '‚úÖ Valid√© et utilis√©'}
                </span>
              </p>
              {ticketInfo.usedAt && (
                <p><strong>‚è∞ Utilis√© le:</strong> {new Date(ticketInfo.usedAt).toLocaleString()}</p>
              )}
            </div>
            
            <div style={{ marginTop: '15px' }}>
              <button 
                onClick={resetScanner}
                style={{
                  background: '#4a90e2',
                  color: 'white',
                  border: 'none',
                  padding: '12px 24px',
                  borderRadius: '8px',
                  fontSize: '16px',
                  cursor: 'pointer',
                  fontWeight: 'bold',
                  boxShadow: '0 4px 8px rgba(0,0,0,0.2)'
                }}
              >
                üîÑ Scanner un autre ticket
              </button>
            </div>
          </div>
        )}

        <div style={{ 
          background: '#f5f5f5', 
          padding: '15px', 
          borderRadius: '8px',
          marginTop: '20px',
          fontSize: '12px',
          textAlign: 'center'
        }}>
          <strong>Status:</strong> {scannerActive ? '‚úÖ Scanner actif' : '‚è∏Ô∏è Scanner arr√™t√©'}
          <br />
          <strong>Biblioth√®que:</strong> html5-qrcode (√©prouv√©e et fiable)
        </div>
      </div>

      <div style={{ textAlign: 'center' }}>
        <a href="/mobile-simple" style={{ 
          color: '#4a90e2', 
          textDecoration: 'none',
          fontSize: '14px',
          padding: '8px 16px',
          border: '1px solid #4a90e2',
          borderRadius: '8px',
          display: 'inline-block',
          background: 'white',
          fontWeight: 'bold',
          boxShadow: '0 4px 8px rgba(0,0,0,0.2)'
        }}>
          ‚Üê Retour √† la saisie manuelle
        </a>
      </div>
    </div>
  );
}
